name: dev env init

on:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  init:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Upload init assets
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          port: ${{ secrets.DEV_SSH_PORT }}
          source: "deploy/dev_init.sh,deploy/systemd/gec-tt-backend.service,deploy/nginx/gec-tt-app.conf,.env.example"
          target: "/tmp/gec-tt-init"

      - name: Run init
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          port: ${{ secrets.DEV_SSH_PORT }}
          script: |
            set -e
            chmod +x /tmp/gec-tt-init/deploy/dev_init.sh
            INIT_ROOT=/tmp/gec-tt-init \
              APP_USER=gec-tt-bot \
              APP_DIR=/opt/gec_tt \
              WEB_DIR=/var/www/gec_tt \
              NGINX_SITE=/etc/nginx/sites-available/gec-annotation.conf \
              /tmp/gec-tt-init/deploy/dev_init.sh
