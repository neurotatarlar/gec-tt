name: vpn enable

on:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  vpn-enable:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Upload VPN scripts
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          port: ${{ secrets.DEV_SSH_PORT }}
          source: "deploy/vpn_enable.sh,deploy/vpn_policy.sh,deploy/vpn_disable.sh,deploy/systemd/gec-tt-vpn-policy.service"
          target: "/tmp/gec-tt-vpn"

      - name: Enable VPN
        uses: appleboy/ssh-action@v1.0.3
        env:
          WG_CONFIG: ${{ secrets.WG_CONFIG }}
          APP_USER: gec-tt-bot
          WG_INTERFACE: wg0
          VPN_TABLE: 51820
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          port: ${{ secrets.DEV_SSH_PORT }}
          envs: WG_CONFIG,APP_USER,WG_INTERFACE,VPN_TABLE
          script: |
            set -e
            chmod +x /tmp/gec-tt-vpn/deploy/vpn_enable.sh /tmp/gec-tt-vpn/deploy/vpn_policy.sh
            INIT_ROOT=/tmp/gec-tt-vpn \
              APP_USER="$APP_USER" \
              WG_INTERFACE="$WG_INTERFACE" \
              VPN_TABLE="$VPN_TABLE" \
              WG_CONFIG="$WG_CONFIG" \
              /tmp/gec-tt-vpn/deploy/vpn_enable.sh
