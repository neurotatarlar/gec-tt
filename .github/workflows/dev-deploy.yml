name: dev env deploy

on:
  push:
    branches:
      - master
    paths:
      - "backend/**"
      - "client/**"
      - "requirements*.txt"
      - "pyproject.toml"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      client: ${{ steps.filter.outputs.client }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            backend:
              - "backend/**"
              - "requirements*.txt"
              - "pyproject.toml"
            client:
              - "client/**"

  backend:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.backend == 'true' || github.event_name == 'workflow_dispatch'
    timeout-minutes: 25
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt

      - name: Install backend dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt -r requirements-dev.txt

      - name: Lint backend
        env:
          PYTHON: python
        run: make lint-backend

      - name: Security checks (backend)
        env:
          PYTHON: python
        run: make security-backend

      - name: Test backend
        env:
          PYTHON: python
        run: make test-backend

      - name: Build backend wheel
        run: |
          python -m pip install --upgrade pip build
          python -m build --wheel --outdir dist
      - name: Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-wheel
          path: dist/*.whl

  client:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.client == 'true' || github.event_name == 'workflow_dispatch'
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Lint client
        env:
          FLUTTER: flutter
          DART: dart
        run: make lint-client

      - name: Test client
        env:
          FLUTTER: flutter
          DART: dart
        run: make test-client

      - name: Build web bundle
        run: |
          sudo apt-get update
          sudo apt-get install -y brotli
          WASM_FLAG=""
          if [ "${WEB_WASM:-false}" = "true" ]; then
            WASM_FLAG="--wasm"
          fi
          python -c "import os, json; from pathlib import Path; path = Path('client/assets/config.json'); data = json.loads(path.read_text()); data['baseUrl'] = '/app/api'; data['buildSha'] = os.environ.get('GITHUB_SHA', ''); path.write_text(json.dumps(data, indent=2) + '\n')"
          cd client
          flutter pub get
          flutter build web --base-href /app/ $WASM_FLAG --tree-shake-icons
          if [ "${WEB_WASM:-false}" = "true" ]; then
          python -c "from pathlib import Path; path = Path('build/web/index.html'); text = path.read_text(); needle = '<link rel=\"preload\" href=\"flutter_bootstrap.js\" as=\"script\">'; wasm = '<link rel=\"preload\" href=\"main.dart.wasm\" as=\"fetch\" type=\"application/wasm\" crossorigin>'; text = text if wasm in text else text.replace(needle, f\"{needle}\\n  {wasm}\"); path.write_text(text)"
          fi
          bash ../deploy/precompress_web.sh build/web
          tar -czf ../web.tar.gz -C build/web .

      - name: Upload web artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-bundle
          path: web.tar.gz

  deploy:
    runs-on: ubuntu-latest
    needs:
      - backend
      - client
    if: needs.backend.result == 'success' || needs.client.result == 'success' || github.event_name == 'workflow_dispatch'
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download backend artifact
        if: needs.backend.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: backend-wheel
          path: artifacts/backend

      - name: Download web artifact
        if: needs.client.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: web-bundle
          path: artifacts/web

      - name: Prepare deploy bundle
        run: |
          rm -rf bundle
          mkdir -p bundle/deploy/nginx bundle/dist
          cp deploy/dev_deploy.sh bundle/deploy/
          cp deploy/nginx/gec-tt-app.conf bundle/deploy/nginx/
          cp deploy/nginx/gec-tt-brotli.conf bundle/deploy/nginx/
          if ls artifacts/backend/*.whl >/dev/null 2>&1; then
            cp artifacts/backend/*.whl bundle/dist/
          fi
          if [ -f artifacts/web/web.tar.gz ]; then
            cp artifacts/web/web.tar.gz bundle/web.tar.gz
          fi
          tar -czf deploy_bundle.tar.gz -C bundle .

      - name: Upload deploy bundle
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          port: ${{ secrets.DEV_SSH_PORT }}
          source: "deploy_bundle.tar.gz"
          target: "/tmp"

      - name: Deploy
        uses: appleboy/ssh-action@v1.0.3
        env:
          GEMINI_API_KEYS: ${{ secrets.GEMINI_API_KEYS }}
          GEMINI_MODEL: gemini-3-flash-preview
          MODEL_BACKEND: gemini
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          port: ${{ secrets.DEV_SSH_PORT }}
          envs: MODEL_BACKEND,GEMINI_MODEL,GEMINI_API_KEYS
          script: |
            set -e
            rm -rf /tmp/gec-tt-deploy
            mkdir -p /tmp/gec-tt-deploy
            tar -xzf /tmp/deploy_bundle.tar.gz -C /tmp/gec-tt-deploy
            chmod +x /tmp/gec-tt-deploy/deploy/dev_deploy.sh
            WHEEL_PATH=$(ls /tmp/gec-tt-deploy/dist/*.whl 2>/dev/null | head -n 1 || true)
            WEB_ARCHIVE="/tmp/gec-tt-deploy/web.tar.gz"
            HAS_WHEEL=false
            HAS_WEB=false
            if [ -n "$WHEEL_PATH" ]; then
              HAS_WHEEL=true
            fi
            if [ -f "$WEB_ARCHIVE" ]; then
              HAS_WEB=true
            fi
            APP_VERSION="dev-${{ github.sha }}"
            APP_GIT_SHA="${{ github.sha }}"
            APP_USER=gec-tt-bot \
              APP_DIR=/opt/gec_tt \
              WEB_DIR=/var/www/gec_tt \
              NGINX_SNIPPET_SRC=/tmp/gec-tt-deploy/deploy/nginx/gec-tt-app.conf \
              NGINX_BROTLI_SRC=/tmp/gec-tt-deploy/deploy/nginx/gec-tt-brotli.conf \
              WHEEL_PATH="$WHEEL_PATH" \
              WEB_ARCHIVE="$WEB_ARCHIVE" \
              APP_VERSION="$APP_VERSION" \
              APP_GIT_SHA="$APP_GIT_SHA" \
              MODEL_BACKEND="$MODEL_BACKEND" \
              GEMINI_MODEL="$GEMINI_MODEL" \
              GEMINI_API_KEYS="$GEMINI_API_KEYS" \
              /tmp/gec-tt-deploy/deploy/dev_deploy.sh
            if [ "$HAS_WHEEL" = true ]; then
              PORT=$(grep -E '^PORT=' /opt/gec_tt/.env | tail -n1 | cut -d= -f2 || true)
              if [ -z "$PORT" ]; then
                PORT=3000
              fi
              for _ in $(seq 1 10); do
                if curl -fsS "http://127.0.0.1:${PORT}/health" >/dev/null; then
                  break
                fi
                sleep 2
              done
              curl -fsS "http://127.0.0.1:${PORT}/health" >/dev/null
            fi
            if [ "$HAS_WEB" = true ]; then
              test -f /var/www/gec_tt/index.html
            fi
