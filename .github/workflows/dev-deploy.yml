name: dev env deploy

on:
  push:
    branches:
      - master
    paths:
      - "backend/**"
      - "client/**"
      - "requirements*.txt"
      - "pyproject.toml"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt

      - name: Install backend dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt -r requirements-dev.txt

      - name: Detect changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            backend:
              - "backend/**"
              - "requirements*.txt"
              - "pyproject.toml"
            client:
              - "client/**"

      - name: Set up Flutter
        if: steps.changes.outputs.client == 'true' || github.event_name == 'workflow_dispatch'
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Lint backend
        if: steps.changes.outputs.backend == 'true' || github.event_name == 'workflow_dispatch'
        env:
          PYTHON: python
        run: make lint-backend

      - name: Security checks (backend)
        if: steps.changes.outputs.backend == 'true' || github.event_name == 'workflow_dispatch'
        env:
          PYTHON: python
        run: make security-backend

      - name: Test backend
        if: steps.changes.outputs.backend == 'true' || github.event_name == 'workflow_dispatch'
        env:
          PYTHON: python
        run: make test-backend

      - name: Lint client
        if: steps.changes.outputs.client == 'true' || github.event_name == 'workflow_dispatch'
        env:
          FLUTTER: flutter
          DART: dart
        run: make lint-client

      - name: Test client
        if: steps.changes.outputs.client == 'true' || github.event_name == 'workflow_dispatch'
        env:
          FLUTTER: flutter
          DART: dart
        run: make test-client

      - name: Build backend wheel
        if: steps.changes.outputs.backend == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          python -m pip install --upgrade pip build
          python -m build --wheel --outdir dist

      - name: Build web bundle
        if: steps.changes.outputs.client == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          sudo apt-get update
          sudo apt-get install -y brotli
          WASM_FLAG=""
          if [ "${WEB_WASM:-false}" = "true" ]; then
            WASM_FLAG="--wasm"
          fi
          python - <<'PY'
          import os
          import json
          from pathlib import Path

          path = Path("client/assets/config.json")
          data = json.loads(path.read_text())
          data["baseUrl"] = "/app/api"
          data["buildSha"] = os.environ.get("GITHUB_SHA", "")
          path.write_text(json.dumps(data, indent=2) + "\n")
          PY
          cd client
          flutter pub get
          flutter build web --base-href /app/ $WASM_FLAG --tree-shake-icons
          if [ "${WEB_WASM:-false}" = "true" ]; then
          python - <<'PY'
          from pathlib import Path
          path = Path("build/web/index.html")
          text = path.read_text()
          needle = '<link rel="preload" href="flutter_bootstrap.js" as="script">'
          wasm = '<link rel="preload" href="main.dart.wasm" as="fetch" type="application/wasm" crossorigin>'
          if wasm not in text:
              text = text.replace(needle, f"{needle}\n  {wasm}")
              path.write_text(text)
          PY
          fi
          bash ../deploy/precompress_web.sh build/web
          tar -czf ../web.tar.gz -C build/web .

      - name: Upload deploy script
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          port: ${{ secrets.DEV_SSH_PORT }}
          source: "deploy/dev_deploy.sh"
          target: "/tmp/gec-tt-deploy"

      - name: Upload backend artifact
        if: steps.changes.outputs.backend == 'true' || github.event_name == 'workflow_dispatch'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          port: ${{ secrets.DEV_SSH_PORT }}
          source: "dist/*.whl"
          target: "/tmp/gec-tt-deploy"

      - name: Upload web artifact
        if: steps.changes.outputs.client == 'true' || github.event_name == 'workflow_dispatch'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          port: ${{ secrets.DEV_SSH_PORT }}
          source: "web.tar.gz"
          target: "/tmp/gec-tt-deploy"

      - name: Upload nginx snippets
        if: steps.changes.outputs.client == 'true' || github.event_name == 'workflow_dispatch'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          port: ${{ secrets.DEV_SSH_PORT }}
          source: "deploy/nginx/gec-tt-app.conf,deploy/nginx/gec-tt-brotli.conf"
          target: "/tmp/gec-tt-deploy"

      - name: Deploy
        uses: appleboy/ssh-action@v1.0.3
        env:
          GEMINI_API_KEYS: ${{ secrets.GEMINI_API_KEYS }}
          GEMINI_MODEL: gemini-3-flash-preview
          MODEL_BACKEND: gemini
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          port: ${{ secrets.DEV_SSH_PORT }}
          envs: MODEL_BACKEND,GEMINI_MODEL,GEMINI_API_KEYS
          script: |
            set -e
            chmod +x /tmp/gec-tt-deploy/deploy/dev_deploy.sh
            WHEEL_PATH=$(ls /tmp/gec-tt-deploy/dist/*.whl 2>/dev/null | head -n 1 || true)
            APP_VERSION="dev-${{ github.sha }}"
            APP_GIT_SHA="${{ github.sha }}"
            APP_USER=gec-tt-bot \
              APP_DIR=/opt/gec_tt \
              WEB_DIR=/var/www/gec_tt \
              NGINX_SNIPPET_SRC=/tmp/gec-tt-deploy/deploy/nginx/gec-tt-app.conf \
              NGINX_BROTLI_SRC=/tmp/gec-tt-deploy/deploy/nginx/gec-tt-brotli.conf \
              WHEEL_PATH="$WHEEL_PATH" \
              WEB_ARCHIVE=/tmp/gec-tt-deploy/web.tar.gz \
              APP_VERSION="$APP_VERSION" \
              APP_GIT_SHA="$APP_GIT_SHA" \
              MODEL_BACKEND="$MODEL_BACKEND" \
              GEMINI_MODEL="$GEMINI_MODEL" \
              GEMINI_API_KEYS="$GEMINI_API_KEYS" \
              /tmp/gec-tt-deploy/deploy/dev_deploy.sh
